AWSTemplateFormatVersion: "2010-09-09"
Metadata:
    Generator: "former2"
Description: ""
Resources:
    CodeBuildProject:
        Type: "AWS::CodeBuild::Project"
        Properties:
            Name: "A2_search"
            Source: 
                BuildSpec: |
                    version: 0.2
                    phases:
                      install:
                        runtime-versions:
                          python: 3.8
                        commands:
                          - echo "Installing dependencies..."
                          - pip install -r requirements.txt -t lib
                      build:
                        commands:
                          - echo "Zipping deployment package..."
                          - cd lib
                          - zip -r9 ../deployment_package.zip .
                          - cd ..
                          - zip -g deployment_package.zip lambda_function.py
                      post_build:
                        commands:
                          - echo "Updating lambda Function..."
                          - aws lambda update-function-code --function-name search-photos --zip-file fileb://deployment_package.zip
                          - echo "DONE!!"
                InsecureSsl: false
                Type: "CODEPIPELINE"
            Artifacts: 
                EncryptionDisabled: false
                Name: "A2_search"
                Packaging: "NONE"
                Type: "CODEPIPELINE"
            Cache: 
                Type: "NO_CACHE"
            Environment: 
                ComputeType: "BUILD_GENERAL1_SMALL"
                Image: "aws/codebuild/amazonlinux2-x86_64-standard:2.0"
                ImagePullCredentialsType: "CODEBUILD"
                PrivilegedMode: false
                Type: "LINUX_CONTAINER"
            ServiceRole: !Sub "arn:aws:iam::${AWS::AccountId}:role/service-role/codebuild-A2_search-service-role"
            TimeoutInMinutes: 60
            QueuedTimeoutInMinutes: 480
            EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/s3"
            BadgeEnabled: false
            LogsConfig: 
                CloudWatchLogs: 
                    Status: "ENABLED"
                S3Logs: 
                    Status: "DISABLED"
                    EncryptionDisabled: false
            Visibility: "PRIVATE"

    CodeBuildProject2:
        Type: "AWS::CodeBuild::Project"
        Properties:
            Name: "A2_Front"
            Source: 
                BuildSpec: |
                    version: 0.2
                    
                    #env:
                      #variables:
                         # key: "value"
                         # key: "value"
                      #parameter-store:
                         # key: "value"
                         # key: "value"
                      #secrets-manager:
                         # key: secret-id:json-key:version-stage:version-id
                         # key: secret-id:json-key:version-stage:version-id
                      #exported-variables:
                         # - variable
                         # - variable
                      #git-credential-helper: yes
                    #batch:
                      #fast-fail: true
                      #build-list:
                      #build-matrix:
                      #build-graph:
                    phases:
                      install:
                        #If you use the Ubuntu standard image 2.0 or later, you must specify runtime-versions.
                        #If you specify runtime-versions and use an image other than Ubuntu standard image 2.0, the build fails.
                        runtime-versions:
                           nodejs: 12
                          # name: version
                        #commands:
                          # - command
                          # - command
                      #pre_build:
                        #commands:
                          # - command
                          # - command
                      build:
                        commands:
                          # - command
                          # - command
                      #post_build:
                        #commands:
                          # - command
                          # - command
                    #reports:
                      #report-name-or-arn:
                        #files:
                          # - location
                          # - location
                        #base-directory: location
                        #discard-paths: yes
                        #file-format: JunitXml | CucumberJson
                    artifacts:
                      files:
                         - '**/*'
                        # - location
                      #name: $(date +%Y-%m-%d)
                      #discard-paths: yes
                      #base-directory: location
                    #cache:
                      #paths:
                        # - paths
                InsecureSsl: false
                Type: "CODEPIPELINE"
            Artifacts: 
                EncryptionDisabled: false
                Name: "A2_Front"
                Packaging: "NONE"
                Type: "CODEPIPELINE"
            Cache: 
                Type: "NO_CACHE"
            Environment: 
                ComputeType: "BUILD_GENERAL1_SMALL"
                Image: "aws/codebuild/amazonlinux2-x86_64-standard:2.0"
                ImagePullCredentialsType: "CODEBUILD"
                PrivilegedMode: false
                Type: "LINUX_CONTAINER"
            ServiceRole: !Sub "arn:aws:iam::${AWS::AccountId}:role/service-role/codebuild-A2_Front-service-role"
            TimeoutInMinutes: 60
            QueuedTimeoutInMinutes: 480
            EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/s3"
            BadgeEnabled: false
            LogsConfig: 
                CloudWatchLogs: 
                    Status: "ENABLED"
                S3Logs: 
                    Status: "DISABLED"
                    EncryptionDisabled: false
            Visibility: "PRIVATE"

    CodeBuildProject3:
        Type: "AWS::CodeBuild::Project"
        Properties:
            Name: "A2_index"
            Source: 
                BuildSpec: |
                    version: 0.2
                    phases:
                      install:
                        runtime-versions:
                          python: 3.8
                        commands:
                          - echo "Installing dependencies..."
                          - pip install -r requirements.txt -t lib
                      build:
                        commands:
                          - echo "Zipping deployment package..."
                          - cd lib
                          - zip -r9 ../deployment_package.zip .
                          - cd ..
                          - zip -g deployment_package.zip lambda_function.py
                      post_build:
                        commands:
                          - echo "Updating lambda Function..."
                          - aws lambda update-function-code --function-name index-photos --zip-file fileb://deployment_package.zip
                          - echo "DONE!!"
                InsecureSsl: false
                Type: "CODEPIPELINE"
            Artifacts: 
                EncryptionDisabled: false
                Name: "A2_index"
                Packaging: "NONE"
                Type: "CODEPIPELINE"
            Cache: 
                Type: "NO_CACHE"
            Environment: 
                ComputeType: "BUILD_GENERAL1_SMALL"
                Image: "aws/codebuild/amazonlinux2-x86_64-standard:2.0"
                ImagePullCredentialsType: "CODEBUILD"
                PrivilegedMode: false
                Type: "LINUX_CONTAINER"
            ServiceRole: !Sub "arn:aws:iam::${AWS::AccountId}:role/service-role/codebuild-A2_index-service-role"
            TimeoutInMinutes: 60
            QueuedTimeoutInMinutes: 480
            EncryptionKey: !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/s3"
            BadgeEnabled: false
            LogsConfig: 
                CloudWatchLogs: 
                    Status: "ENABLED"
                S3Logs: 
                    Status: "DISABLED"
                    EncryptionDisabled: false
            Visibility: "PRIVATE"

